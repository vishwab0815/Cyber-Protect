// This is your Prisma schema file for Neon PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id        String   @id @default(cuid())
  email     String?  @unique
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  scans     ScanResult[]
  settings  UserSettings?

  @@map("users")
}

model UserSettings {
  id        String   @id @default(cuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Detection Settings
  realTimeScanning  Boolean @default(true)
  autoQuarantine    Boolean @default(true)
  detectionSensitivity Int  @default(50) // 0-100
  defaultAction     String  @default("warn") // warn, block, quarantine

  // Notifications
  emailAlerts       Boolean @default(true)
  desktopAlerts     Boolean @default(true)
  dailySummary      Boolean @default(false)

  // API Configuration
  apiEndpoint       String?
  apiKey            String?
  rateLimit         Int     @default(100)

  // Security
  autoUpdate        Boolean @default(true)
  dataRetentionDays Int     @default(30)
  securityLevel     String  @default("medium") // low, medium, high, paranoid

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("user_settings")
}

model ScanResult {
  id              String   @id @default(cuid())
  userId          String?
  user            User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  // Scan Information
  type            ScanType
  target          String   @db.Text
  status          ScanStatus @default(COMPLETED)

  // Results
  confidence      Float    // 0-100
  threatLevel     ThreatLevel
  riskScore       Float    // 0-100
  indicators      String[] // Array of threat indicators
  recommendations String[] // Array of recommendations

  // Metadata
  modelVersion    String   @default("v1.0")
  scanDuration    Int?     // milliseconds
  timestamp       DateTime @default(now())

  // Technical Details
  metadata        Json?    // Store additional analysis data

  // Relations
  scanJob         ScanJob? // Link back to job if it exists

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([type])
  @@index([threatLevel])
  @@index([timestamp])
  @@map("scan_results")
}

model ModelConfig {
  id          String   @id @default(cuid())
  modelId     String   @unique
  name        String
  description String?  @db.Text

  // Model State
  state       ModelState @default(ACTIVE)
  version     String

  // Configuration
  confidenceThreshold Float    @default(0.7)
  features            String[] // Array of feature names

  // Metadata
  initializedAt DateTime @default(now())
  updatedAt     DateTime @updatedAt
  lastUsed      DateTime?

  @@map("model_configs")
}

model TrustedDomain {
  id        String   @id @default(cuid())
  domain    String   @unique
  addedBy   String?
  reason    String?  @db.Text
  createdAt DateTime @default(now())

  @@map("trusted_domains")
}

model BlockedDomain {
  id        String   @id @default(cuid())
  domain    String   @unique
  reason    String   @db.Text
  addedBy   String?
  createdAt DateTime @default(now())

  @@map("blocked_domains")
}

model ThreatIntelligence {
  id          String   @id @default(cuid())
  domain      String   @unique
  reputation  Float    // 0-100
  lastChecked DateTime @default(now())
  sources     String[] // Array of intelligence sources
  indicators  Json?    // Store threat indicators

  @@map("threat_intelligence")
}

// Enums
enum ScanType {
  URL
  EMAIL
  MESSAGE
  FILE
}

enum ScanStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  QUARANTINED
  BLOCKED
  ERROR
}

enum ThreatLevel {
  SAFE
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum ModelState {
  ACTIVE
  INACTIVE
  MAINTENANCE
}

// ============================================
// ENHANCED MODELS FOR ADVANCED THREAT DETECTION
// ============================================

model ScanJob {
  id          String     @id @default(cuid())
  userId      String?
  type        ScanType
  target      String     @db.Text
  status      JobStatus  @default(PENDING)
  priority    Int        @default(50) // 1-100, higher = more urgent

  // Results
  scanResultId String?   @unique
  scanResult   ScanResult? @relation(fields: [scanResultId], references: [id])

  // Timing
  createdAt   DateTime  @default(now())
  startedAt   DateTime?
  completedAt DateTime?
  duration    Int?      // milliseconds

  // Error handling
  errorMessage String?  @db.Text
  retryCount   Int     @default(0)
  maxRetries   Int     @default(3)

  // External service tracking
  externalJobId String? // For async external services like URLScan.io

  @@index([userId, createdAt])
  @@index([status, priority])
  @@index([type])
  @@map("scan_jobs")
}

model DomainIntelligence {
  id              String    @id @default(cuid())
  domain          String    @unique

  // WHOIS Data
  registrar       String?
  createdDate     DateTime?
  expiresDate     DateTime?
  updatedDate     DateTime?
  registrantName  String?
  registrantEmail String?
  registrantOrg   String?

  // DNS Data
  ipAddresses     String[]  // A/AAAA records
  mxRecords       String[]  // Mail servers
  nsRecords       String[]  // Name servers
  txtRecords      String[]  // TXT records (SPF/DKIM)

  // Reputation & Risk
  riskScore       Float     @default(50) // 0-100
  isKnownPhishing Boolean   @default(false)
  isKnownMalware  Boolean   @default(false)
  firstSeenPhish  DateTime?
  reportCount     Int       @default(0)

  // Analysis metadata
  domainAge       Int?      // days since creation
  hasPrivacy      Boolean   @default(false)
  isFastFlux      Boolean   @default(false)

  // Cache metadata
  lastChecked     DateTime  @default(now())
  cacheExpiry     DateTime  @default(now())

  @@index([domain])
  @@index([lastChecked])
  @@map("domain_intelligence")
}

model CertificateInfo {
  id              String    @id @default(cuid())
  domain          String

  // Certificate Details
  issuer          String
  subject         String
  validFrom       DateTime
  validUntil      DateTime
  serialNumber    String
  fingerprint     String    @unique
  algorithm       String    // RSA, ECDSA, etc.
  keySize         Int?      // 2048, 4096, etc.

  // Certificate Chain
  chainValid      Boolean   @default(true)
  chainLength     Int       @default(1)

  // Security Analysis
  isSelfSigned    Boolean   @default(false)
  isWildcard      Boolean   @default(false)
  isEV            Boolean   @default(false) // Extended Validation
  sanDomains      String[]  // Subject Alternative Names

  // Certificate Transparency
  ctLogged        Boolean   @default(false)
  ctLogCount      Int       @default(0)

  // Risk Assessment
  trustScore      Float     @default(50) // 0-100
  isRevoked       Boolean   @default(false)
  hasWeakCipher   Boolean   @default(false)

  // Metadata
  lastChecked     DateTime  @default(now())
  checkCount      Int       @default(1)

  @@index([domain])
  @@index([validUntil])
  @@index([fingerprint])
  @@map("certificate_info")
}

model IPIntelligence {
  id              String    @id @default(cuid())
  ipAddress       String    @unique

  // Geolocation
  country         String?
  countryCode     String?
  region          String?
  city            String?
  latitude        Float?
  longitude       Float?
  timezone        String?

  // Network Information
  asn             String?   // Autonomous System Number
  asnOrg          String?   // AS Organization
  isp             String?
  organization    String?

  // Security & Reputation
  abuseScore      Int       @default(0) // 0-100
  threatScore     Float     @default(0) // 0-100
  isProxy         Boolean   @default(false)
  isVPN           Boolean   @default(false)
  isTor           Boolean   @default(false)
  isDataCenter    Boolean   @default(false)
  isHosting       Boolean   @default(false)

  // Threat Intelligence
  isBlacklisted   Boolean   @default(false)
  blacklistCount  Int       @default(0)
  isBot           Boolean   @default(false)

  // Historical Data
  firstSeen       DateTime  @default(now())
  lastChecked     DateTime  @default(now())
  checkCount      Int       @default(1)

  @@index([ipAddress])
  @@index([abuseScore])
  @@index([lastChecked])
  @@map("ip_intelligence")
}

model ExternalScanResult {
  id              String    @id @default(cuid())
  scanResultId    String
  provider        String    // "virustotal", "google_safe_browsing", etc.

  // Raw Response
  rawResponse     Json      // Full API response

  // Normalized Results
  isPhishing      Boolean   @default(false)
  isMalware       Boolean   @default(false)
  isSpam          Boolean   @default(false)
  threatType      String?   // Categorized threat type
  confidence      Float?    // Provider's confidence score

  // Provider Metadata
  detectionCount  Int       @default(0) // Engines that detected threat
  totalEngines    Int       @default(0) // Total engines checked
  scanDate        DateTime  @default(now())

  // Caching
  expiresAt       DateTime?

  createdAt       DateTime  @default(now())

  @@index([scanResultId])
  @@index([provider])
  @@map("external_scan_results")
}

model APIUsage {
  id              String    @id @default(cuid())
  userId          String
  endpoint        String
  method          String    @default("POST")

  // Rate Limiting
  requestCount    Int       @default(1)
  windowStart     DateTime  @default(now())
  windowEnd       DateTime

  // Quotas
  dailyLimit      Int       @default(1000)
  monthlyLimit    Int       @default(30000)
  dailyUsed       Int       @default(0)
  monthlyUsed     Int       @default(0)

  // Metadata
  lastRequest     DateTime  @default(now())

  @@unique([userId, endpoint, windowStart])
  @@index([userId])
  @@index([windowStart])
  @@map("api_usage")
}

// ============================================
// MALWARE ANALYSIS MODELS
// ============================================

model FileAnalysis {
  id              String    @id @default(cuid())
  userId          String?

  // File Metadata
  fileName        String
  fileSize        Int       // bytes
  fileType        String    // MIME type
  fileExtension   String

  // Hash Identifiers
  md5             String    @unique
  sha1            String    @unique
  sha256          String    @unique
  ssdeep          String?   // Fuzzy hash for similarity detection

  // Analysis Results
  isMalicious     Boolean   @default(false)
  malwareFamily   String?   // Trojan, Ransomware, Spyware, etc.
  threatLevel     ThreatLevel
  confidence      Float     // 0-100
  riskScore       Float     // 0-100

  // Detection Details
  detectionNames  String[]  // Names from different engines
  indicators      String[]  // Behavioral indicators
  tags            String[]  // malware, packer, obfuscated, etc.

  // File Properties
  isPacked        Boolean   @default(false)
  isObfuscated    Boolean   @default(false)
  isEncrypted     Boolean   @default(false)
  hasSuspiciousAPI Boolean  @default(false)

  // Behavioral Analysis
  networkActivity Json?     // Network connections attempted
  fileOperations  Json?     // File read/write/delete operations
  registryChanges Json?     // Windows registry modifications
  processCreation Json?     // New processes spawned

  // External Scan Results
  virusTotalDetections Int  @default(0)
  virusTotalEngines    Int  @default(0)

  // Sandbox Results
  sandboxProvider  String?  // joe_sandbox, any.run, hybrid_analysis
  sandboxScore     Float?   // 0-100
  sandboxReport    Json?    // Full sandbox report

  // Metadata
  firstSeen       DateTime  @default(now())
  lastScanned     DateTime  @default(now())
  scanCount       Int       @default(1)

  // Relations
  signatures      MalwareSignature[]

  @@index([md5])
  @@index([sha256])
  @@index([isMalicious])
  @@index([malwareFamily])
  @@index([firstSeen])
  @@map("file_analysis")
}

model MalwareSignature {
  id              String    @id @default(cuid())

  // Signature Details
  name            String
  type            SignatureType
  pattern         String    @db.Text // YARA rule, regex, byte pattern
  description     String?   @db.Text

  // Classification
  severity        ThreatLevel
  malwareFamily   String?
  category        String    // trojan, ransomware, spyware, adware, etc.

  // Pattern Matching
  caseSensitive   Boolean   @default(false)
  offset          Int?      // Byte offset in file
  length          Int?      // Pattern length

  // Metadata
  source          String    // yara, custom, community, vendor
  version         String    @default("1.0")
  author          String?
  reference       String?   // URL to more info

  // Status
  isActive        Boolean   @default(true)
  falsePositiveRate Float   @default(0) // 0-1

  // Usage Stats
  detectionCount  Int       @default(0)
  lastDetection   DateTime?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  fileAnalyses    FileAnalysis[]

  @@index([type])
  @@index([malwareFamily])
  @@index([isActive])
  @@map("malware_signatures")
}

model FileUpload {
  id              String    @id @default(cuid())
  userId          String?

  // Upload Details
  originalName    String
  storedPath      String    // Quarantined file location
  fileSize        Int       // bytes
  mimeType        String

  // Hash for deduplication
  sha256          String

  // Upload Status
  uploadStatus    UploadStatus @default(UPLOADED)
  scanStatus      ScanStatus   @default(PENDING)

  // Quarantine
  isQuarantined   Boolean   @default(true)
  quarantineReason String? @db.Text

  // Analysis Reference
  analysisId      String?   @unique

  // Metadata
  uploadedAt      DateTime  @default(now())
  scannedAt       DateTime?
  expiresAt       DateTime  // Auto-delete after X days

  @@index([userId])
  @@index([sha256])
  @@index([scanStatus])
  @@index([uploadedAt])
  @@map("file_uploads")
}

model MalwareThreatFeed {
  id              String    @id @default(cuid())

  // Threat Indicator
  indicatorType   IndicatorType
  indicatorValue  String    @db.Text // Hash, IP, domain, URL, etc.

  // Threat Details
  threatType      String    // malware, ransomware, c2, phishing
  malwareFamily   String?
  severity        ThreatLevel
  confidence      Float     // 0-100

  // Context
  description     String?   @db.Text
  targetSectors   String[]  // finance, healthcare, government, etc.
  targetCountries String[]  // Country codes

  // Source Information
  source          String    // feed provider
  feedName        String    // specific feed name
  tlpLevel        String    @default("white") // TLP: white, green, amber, red

  // Timestamps
  firstSeen       DateTime
  lastSeen        DateTime
  expiresAt       DateTime?

  // Status
  isActive        Boolean   @default(true)
  isFalsePositive Boolean   @default(false)

  // Metadata
  tags            String[]
  references      String[]  // URLs to more info

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([indicatorType, indicatorValue])
  @@index([indicatorType])
  @@index([malwareFamily])
  @@index([isActive])
  @@index([firstSeen])
  @@map("malware_threat_feeds")
}

// Enhanced Enums
enum JobStatus {
  PENDING      // Job created, waiting to start
  QUEUED       // In queue for processing
  PROCESSING   // Currently being processed
  COMPLETED    // Successfully completed
  FAILED       // Failed with error
  CANCELLED    // Manually cancelled
  TIMEOUT      // Exceeded time limit
}

enum SignatureType {
  YARA         // YARA rule
  REGEX        // Regular expression
  HASH         // File hash (MD5, SHA1, SHA256)
  BYTE_PATTERN // Raw byte pattern
  BEHAVIORAL   // Behavioral pattern
  HEURISTIC    // Heuristic detection
}

enum UploadStatus {
  UPLOADED     // File uploaded successfully
  PROCESSING   // Being processed
  STORED       // Stored in quarantine
  DELETED      // Deleted from system
  ERROR        // Upload error
}

enum IndicatorType {
  FILE_HASH    // MD5, SHA1, SHA256
  IP_ADDRESS   // IPv4/IPv6
  DOMAIN       // Domain name
  URL          // Full URL
  EMAIL        // Email address
  MUTEX        // Mutex name (malware synchronization)
  REGISTRY_KEY // Windows registry key
  FILE_PATH    // File system path
  CVE          // CVE identifier
}
