/**
 * Document Malware Analysis
 * Detects malicious content in Office documents, PDFs, and other document types
 */

export interface DocumentAnalysisResult {
  isMalicious: boolean;
  riskScore: number;
  indicators: string[];
  documentType: string;
  hasMacros: boolean;
  hasEmbeddedObjects: boolean;
  hasJavaScript: boolean;
  hasExternalLinks: number;
  suspiciousFeatures: string[];
  recommendations: string[];
}

export class DocumentAnalyzer {
  /**
   * Analyze document for malicious content
   */
  static async analyzeDocument(
    buffer: Buffer,
    fileName: string
  ): Promise<DocumentAnalysisResult> {
    const indicators: string[] = [];
    const suspiciousFeatures: string[] = [];
    let riskScore = 0;

    // Detect document type
    const documentType = this.detectDocumentType(buffer, fileName);

    // Analyze based on document type
    let hasMacros = false;
    let hasEmbeddedObjects = false;
    let hasJavaScript = false;
    let hasExternalLinks = 0;

    switch (documentType) {
      case 'office':
        const officeAnalysis = this.analyzeOfficeDocument(buffer);
        hasMacros = officeAnalysis.hasMacros;
        hasEmbeddedObjects = officeAnalysis.hasEmbeddedObjects;
        hasExternalLinks = officeAnalysis.hasExternalLinks;

        if (hasMacros) {
          indicators.push('Document contains macros');
          riskScore += 40;
          suspiciousFeatures.push('VBA macros detected');
        }

        if (hasEmbeddedObjects) {
          indicators.push('Document has embedded objects');
          riskScore += 25;
          suspiciousFeatures.push('Embedded OLE objects');
        }

        if (officeAnalysis.hasAutoOpen) {
          indicators.push('Auto-execution macro detected');
          riskScore += 35;
          suspiciousFeatures.push('Auto-open/auto-exec macros');
        }
        break;

      case 'pdf':
        const pdfAnalysis = this.analyzePDF(buffer);
        hasJavaScript = pdfAnalysis.hasJavaScript;
        hasEmbeddedObjects = pdfAnalysis.hasEmbeddedFiles;
        hasExternalLinks = pdfAnalysis.hasExternalLinks;

        if (hasJavaScript) {
          indicators.push('PDF contains JavaScript');
          riskScore += 30;
          suspiciousFeatures.push('Embedded JavaScript');
        }

        if (pdfAnalysis.hasEmbeddedFiles) {
          indicators.push('PDF has embedded files');
          riskScore += 25;
          suspiciousFeatures.push('Embedded file streams');
        }

        if (pdfAnalysis.hasLaunchActions) {
          indicators.push('PDF has auto-launch actions');
          riskScore += 40;
          suspiciousFeatures.push('Launch actions');
        }
        break;

      case 'rtf':
        const rtfAnalysis = this.analyzeRTF(buffer);
        if (rtfAnalysis.hasEmbeddedObjects) {
          indicators.push('RTF contains embedded objects');
          riskScore += 30;
          hasEmbeddedObjects = true;
        }
        break;
    }

    // Check for suspicious external links
    if (hasExternalLinks > 0) {
      indicators.push(`Document has ${hasExternalLinks} external links`);
      riskScore += Math.min(hasExternalLinks * 5, 20);
    }

    // Check filename tricks
    if (/\s+\.[a-z]{3,4}$/i.test(fileName)) {
      indicators.push('Filename has suspicious spacing before extension');
      riskScore += 15;
    }

    const isMalicious = riskScore >= 60;
    const recommendations = this.generateRecommendations(riskScore, hasMacros, hasJavaScript);

    return {
      isMalicious,
      riskScore: Math.min(riskScore, 100),
      indicators,
      documentType,
      hasMacros,
      hasEmbeddedObjects,
      hasJavaScript,
      hasExternalLinks,
      suspiciousFeatures,
      recommendations,
    };
  }

  /**
   * Detect document type
   */
  private static detectDocumentType(buffer: Buffer, fileName: string): string {
    const hex = buffer.toString('hex', 0, Math.min(buffer.length, 20));

    // Office documents (ZIP-based: docx, xlsx, pptx)
    if (hex.startsWith('504b0304')) {
      if (fileName.match(/\.(docx|xlsx|pptx|docm|xlsm|pptm)$/i)) {
        return 'office';
      }
    }

    // Old Office documents (OLE2-based: doc, xls, ppt)
    if (hex.startsWith('d0cf11e0')) {
      return 'office';
    }

    // PDF
    if (hex.startsWith('25504446')) {
      return 'pdf';
    }

    // RTF
    if (hex.startsWith('7b5c7274')) {
      return 'rtf';
    }

    return 'unknown';
  }

  /**
   * Analyze Office documents
   */
  private static analyzeOfficeDocument(buffer: Buffer) {
    const content = buffer.toString('utf8');

    // Check for macros
    const hasMacros =
      content.includes('vbaProject') ||
      content.includes('macros/') ||
      /\.(docm|xlsm|pptm)/i.test(content);

    // Check for auto-execution macros
    const hasAutoOpen =
      content.includes('AutoOpen') ||
      content.includes('Auto_Open') ||
      content.includes('Workbook_Open') ||
      content.includes('Document_Open');

    // Check for embedded objects
    const hasEmbeddedObjects =
      content.includes('embeddings/') ||
      content.includes('oleObject') ||
      content.includes('package');

    // Count external links
    const externalLinkPattern = /(http|https|ftp):\/\/[^\s<>"]+/gi;
    const hasExternalLinks = (content.match(externalLinkPattern) || []).length;

    return {
      hasMacros,
      hasAutoOpen,
      hasEmbeddedObjects,
      hasExternalLinks,
    };
  }

  /**
   * Analyze PDF documents
   */
  private static analyzePDF(buffer: Buffer) {
    const content = buffer.toString('utf8');

    // Check for JavaScript
    const hasJavaScript =
      content.includes('/JavaScript') ||
      content.includes('/JS') ||
      content.includes('app.alert');

    // Check for embedded files
    const hasEmbeddedFiles =
      content.includes('/EmbeddedFile') || content.includes('/FileAttachment');

    // Check for launch actions
    const hasLaunchActions = content.includes('/Launch') || content.includes('/Action');

    // Count external links
    const externalLinkPattern = /\/URI\s*<</gi;
    const hasExternalLinks = (content.match(externalLinkPattern) || []).length;

    return {
      hasJavaScript,
      hasEmbeddedFiles,
      hasLaunchActions,
      hasExternalLinks,
    };
  }

  /**
   * Analyze RTF documents
   */
  private static analyzeRTF(buffer: Buffer) {
    const content = buffer.toString('utf8');

    // Check for embedded objects
    const hasEmbeddedObjects =
      content.includes('\\object') ||
      content.includes('\\objdata') ||
      content.includes('\\objemb');

    return {
      hasEmbeddedObjects,
    };
  }

  /**
   * Generate recommendations
   */
  private static generateRecommendations(
    riskScore: number,
    hasMacros: boolean,
    hasJavaScript: boolean
  ): string[] {
    const recommendations: string[] = [];

    if (riskScore >= 60) {
      recommendations.push('HIGH RISK: Do not open this document');
      recommendations.push('Document contains multiple suspicious features');
      recommendations.push('Scan with updated antivirus before opening');
    } else if (riskScore >= 40) {
      recommendations.push('Exercise caution when opening this document');
      recommendations.push('Disable macros unless from trusted source');
      recommendations.push('Open in protected view or sandbox');
    } else if (riskScore >= 20) {
      recommendations.push('Document has some suspicious features');
      recommendations.push('Verify sender before enabling any macros');
    } else {
      recommendations.push('Document appears safe');
    }

    if (hasMacros) {
      recommendations.push('IMPORTANT: Do not enable macros unless absolutely necessary');
    }

    if (hasJavaScript) {
      recommendations.push('Disable JavaScript execution in PDF reader');
    }

    return recommendations;
  }
}
