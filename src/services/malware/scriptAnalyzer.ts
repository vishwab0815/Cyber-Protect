/**
 * Script Malware Analysis
 * Detects malicious code in JavaScript, PowerShell, VBScript, Python, and other scripts
 */

export interface ScriptAnalysisResult {
  isMalicious: boolean;
  scriptType: string;
  riskScore: number;
  indicators: string[];
  suspiciousPatterns: {
    obfuscation: boolean;
    encodedCommands: boolean;
    networkActivity: boolean;
    fileOperations: boolean;
    processExecution: boolean;
    registryModification: boolean;
    credentialAccess: boolean;
  };
  dangerousFunctions: string[];
  recommendations: string[];
}

export class ScriptAnalyzer {
  /**
   * Analyze script file for malicious content
   */
  static async analyzeScript(buffer: Buffer, fileName: string): Promise<ScriptAnalysisResult> {
    const content = buffer.toString('utf8');
    const indicators: string[] = [];
    const dangerousFunctions: string[] = [];
    let riskScore = 0;

    // Detect script type
    const scriptType = this.detectScriptType(fileName, content);

    // Initialize suspicious patterns
    const suspiciousPatterns = {
      obfuscation: false,
      encodedCommands: false,
      networkActivity: false,
      fileOperations: false,
      processExecution: false,
      registryModification: false,
      credentialAccess: false,
    };

    // Analyze based on script type
    switch (scriptType) {
      case 'javascript':
        const jsAnalysis = this.analyzeJavaScript(content);
        Object.assign(suspiciousPatterns, jsAnalysis.patterns);
        indicators.push(...jsAnalysis.indicators);
        dangerousFunctions.push(...jsAnalysis.dangerousFunctions);
        riskScore += jsAnalysis.riskScore;
        break;

      case 'powershell':
        const psAnalysis = this.analyzePowerShell(content);
        Object.assign(suspiciousPatterns, psAnalysis.patterns);
        indicators.push(...psAnalysis.indicators);
        dangerousFunctions.push(...psAnalysis.dangerousFunctions);
        riskScore += psAnalysis.riskScore;
        break;

      case 'vbscript':
        const vbsAnalysis = this.analyzeVBScript(content);
        Object.assign(suspiciousPatterns, vbsAnalysis.patterns);
        indicators.push(...vbsAnalysis.indicators);
        dangerousFunctions.push(...vbsAnalysis.dangerousFunctions);
        riskScore += vbsAnalysis.riskScore;
        break;

      case 'python':
        const pyAnalysis = this.analyzePython(content);
        Object.assign(suspiciousPatterns, pyAnalysis.patterns);
        indicators.push(...pyAnalysis.indicators);
        dangerousFunctions.push(...pyAnalysis.dangerousFunctions);
        riskScore += pyAnalysis.riskScore;
        break;

      case 'bash':
        const bashAnalysis = this.analyzeBash(content);
        Object.assign(suspiciousPatterns, bashAnalysis.patterns);
        indicators.push(...bashAnalysis.indicators);
        dangerousFunctions.push(...bashAnalysis.dangerousFunctions);
        riskScore += bashAnalysis.riskScore;
        break;
    }

    const isMalicious = riskScore >= 60;
    const recommendations = this.generateRecommendations(riskScore, scriptType, suspiciousPatterns);

    return {
      isMalicious,
      scriptType,
      riskScore: Math.min(riskScore, 100),
      indicators,
      suspiciousPatterns,
      dangerousFunctions,
      recommendations,
    };
  }

  /**
   * Detect script type
   */
  private static detectScriptType(fileName: string, content: string): string {
    const ext = fileName.toLowerCase().match(/\.([^.]+)$/)?.[1];

    if (ext === 'js') return 'javascript';
    if (ext === 'ps1') return 'powershell';
    if (ext === 'vbs') return 'vbscript';
    if (ext === 'py') return 'python';
    if (ext === 'sh' || ext === 'bash') return 'bash';
    if (ext === 'bat' || ext === 'cmd') return 'batch';

    // Detect from content
    if (content.includes('#!/usr/bin/python') || content.includes('import ')) return 'python';
    if (content.includes('#!/bin/bash') || content.includes('#!/bin/sh')) return 'bash';
    if (content.includes('param(') || content.includes('Write-Host')) return 'powershell';

    return 'unknown';
  }

  /**
   * Analyze JavaScript
   */
  private static analyzeJavaScript(content: string) {
    const indicators: string[] = [];
    const dangerousFunctions: string[] = [];
    let riskScore = 0;

    const patterns = {
      obfuscation: false,
      encodedCommands: false,
      networkActivity: false,
      fileOperations: false,
      processExecution: false,
      registryModification: false,
      credentialAccess: false,
    };

    // Check for obfuscation
    if (/eval\s*\(/i.test(content)) {
      patterns.obfuscation = true;
      indicators.push('eval() detected - code obfuscation');
      dangerousFunctions.push('eval');
      riskScore += 25;
    }

    if (/Function\s*\(/i.test(content) || /\bFunction\s*\[/i.test(content)) {
      patterns.obfuscation = true;
      indicators.push('Dynamic Function() constructor');
      riskScore += 20;
    }

    // Encoding detection
    if (/fromCharCode|atob|unescape/i.test(content)) {
      patterns.encodedCommands = true;
      indicators.push('Encoded command execution detected');
      riskScore += 30;
    }

    // Network activity
    if (/XMLHttpRequest|fetch\(|axios\.|\.ajax\(/i.test(content)) {
      patterns.networkActivity = true;
      // Not necessarily malicious, but flag it
      if (content.includes('eval') || patterns.obfuscation) {
        indicators.push('Network requests with code execution');
        riskScore += 20;
      }
    }

    // File operations (Node.js)
    if (/require\(['"]fs['"]\)|fs\.write|fs\.read|fs\.unlink/i.test(content)) {
      patterns.fileOperations = true;
      indicators.push('File system operations');
      riskScore += 15;
    }

    // Process execution (Node.js)
    if (/child_process|exec\(|spawn\(|fork\(/i.test(content)) {
      patterns.processExecution = true;
      indicators.push('Process execution capability');
      dangerousFunctions.push('child_process');
      riskScore += 30;
    }

    // Excessive obfuscation
    const hexCount = (content.match(/\\x[0-9a-f]{2}/gi) || []).length;
    if (hexCount > 50) {
      patterns.obfuscation = true;
      indicators.push('Heavy hex encoding detected');
      riskScore += 20;
    }

    return { indicators, dangerousFunctions, riskScore, patterns };
  }

  /**
   * Analyze PowerShell
   */
  private static analyzePowerShell(content: string) {
    const indicators: string[] = [];
    const dangerousFunctions: string[] = [];
    let riskScore = 0;

    const patterns = {
      obfuscation: false,
      encodedCommands: false,
      networkActivity: false,
      fileOperations: false,
      processExecution: false,
      registryModification: false,
      credentialAccess: false,
    };

    // Base64 encoded commands
    if (/-enc\s+|-encodedcommand\s+/i.test(content)) {
      patterns.encodedCommands = true;
      indicators.push('Base64 encoded PowerShell command');
      riskScore += 35;
    }

    // Download cradles
    if (/Invoke-WebRequest|Invoke-RestMethod|Net\.WebClient|DownloadString|DownloadFile/i.test(content)) {
      patterns.networkActivity = true;
      indicators.push('Remote file download capability');
      dangerousFunctions.push('Invoke-WebRequest');
      riskScore += 30;
    }

    // Code execution
    if (/Invoke-Expression|IEX\s+/i.test(content)) {
      patterns.obfuscation = true;
      indicators.push('Dynamic code execution (IEX)');
      dangerousFunctions.push('Invoke-Expression');
      riskScore += 40;
    }

    // Process manipulation
    if (/Start-Process|New-Object.*ProcessStartInfo/i.test(content)) {
      patterns.processExecution = true;
      indicators.push('Process creation detected');
      riskScore += 25;
    }

    // Registry modification
    if (/New-ItemProperty|Set-ItemProperty|Registry::/i.test(content)) {
      patterns.registryModification = true;
      indicators.push('Windows Registry modification');
      dangerousFunctions.push('Registry modification');
      riskScore += 30;
    }

    // Credential harvesting
    if (/Get-Credential|ConvertFrom-SecureString|mimikatz/i.test(content)) {
      patterns.credentialAccess = true;
      indicators.push('Credential access detected');
      riskScore += 50;
    }

    // Disable security features
    if (/Set-ExecutionPolicy.*Bypass|-ExecutionPolicy\s+Bypass/i.test(content)) {
      indicators.push('Attempts to bypass execution policy');
      riskScore += 35;
    }

    // Anti-virus evasion
    if (/AMSI|AmsiScanBuffer|Defender/i.test(content)) {
      indicators.push('Possible anti-virus evasion');
      riskScore += 40;
    }

    return { indicators, dangerousFunctions, riskScore, patterns };
  }

  /**
   * Analyze VBScript
   */
  private static analyzeVBScript(content: string) {
    const indicators: string[] = [];
    const dangerousFunctions: string[] = [];
    let riskScore = 0;

    const patterns = {
      obfuscation: false,
      encodedCommands: false,
      networkActivity: false,
      fileOperations: false,
      processExecution: false,
      registryModification: false,
      credentialAccess: false,
    };

    // Shell execution
    if (/WScript\.Shell|CreateObject.*Shell\.Application/i.test(content)) {
      patterns.processExecution = true;
      indicators.push('Windows Shell access');
      dangerousFunctions.push('WScript.Shell');
      riskScore += 30;
    }

    // Process execution
    if (/\.Run\s*\(|\.Exec\s*\(/i.test(content)) {
      patterns.processExecution = true;
      indicators.push('Command execution capability');
      riskScore += 35;
    }

    // Network access
    if (/MSXML2\.XMLHTTP|WinHttp\.WinHttpRequest/i.test(content)) {
      patterns.networkActivity = true;
      indicators.push('HTTP request capability');
      riskScore += 25;
    }

    // File operations
    if (/Scripting\.FileSystemObject|\.CreateTextFile|\.OpenTextFile/i.test(content)) {
      patterns.fileOperations = true;
      indicators.push('File system access');
      riskScore += 20;
    }

    // Registry access
    if (/\.RegWrite|\.RegRead|\.RegDelete/i.test(content)) {
      patterns.registryModification = true;
      indicators.push('Registry manipulation');
      riskScore += 30;
    }

    return { indicators, dangerousFunctions, riskScore, patterns };
  }

  /**
   * Analyze Python
   */
  private static analyzePython(content: string) {
    const indicators: string[] = [];
    const dangerousFunctions: string[] = [];
    let riskScore = 0;

    const patterns = {
      obfuscation: false,
      encodedCommands: false,
      networkActivity: false,
      fileOperations: false,
      processExecution: false,
      registryModification: false,
      credentialAccess: false,
    };

    // Code execution
    if (/\beval\(|\bexec\(|compile\(/i.test(content)) {
      patterns.obfuscation = true;
      indicators.push('Dynamic code execution');
      dangerousFunctions.push('eval/exec');
      riskScore += 30;
    }

    // Process execution
    if (/subprocess|os\.system|os\.popen|os\.exec/i.test(content)) {
      patterns.processExecution = true;
      indicators.push('System command execution');
      dangerousFunctions.push('subprocess');
      riskScore += 35;
    }

    // Network activity
    if (/import requests|import urllib|import socket|http\.client/i.test(content)) {
      patterns.networkActivity = true;
      // Not necessarily malicious
      if (content.includes('eval') || content.includes('exec')) {
        indicators.push('Network activity with code execution');
        riskScore += 25;
      }
    }

    // Encoding
    if (/base64\.b64decode|base64\.decode|codecs\.decode/i.test(content)) {
      patterns.encodedCommands = true;
      indicators.push('Base64 decoding (possible payload)');
      riskScore += 20;
    }

    // Cryptography (could be ransomware)
    if (/from cryptography|import Crypto|AES\.new|RSA\.new/i.test(content)) {
      if (/\.encrypt|\.decrypt/i.test(content)) {
        indicators.push('Encryption operations detected');
        riskScore += 15;
      }
    }

    return { indicators, dangerousFunctions, riskScore, patterns };
  }

  /**
   * Analyze Bash
   */
  private static analyzeBash(content: string) {
    const indicators: string[] = [];
    const dangerousFunctions: string[] = [];
    let riskScore = 0;

    const patterns = {
      obfuscation: false,
      encodedCommands: false,
      networkActivity: false,
      fileOperations: false,
      processExecution: false,
      registryModification: false,
      credentialAccess: false,
    };

    // Download and execute
    if (/curl.*\|\s*bash|wget.*\|\s*sh|bash\s*-c/i.test(content)) {
      patterns.networkActivity = true;
      patterns.processExecution = true;
      indicators.push('Download and execute pattern');
      riskScore += 50;
    }

    // Base64 encoded commands
    if (/base64\s+-d|echo.*base64/i.test(content)) {
      patterns.encodedCommands = true;
      indicators.push('Base64 decoding detected');
      riskScore += 25;
    }

    // Reverse shell indicators
    if (/\/dev\/tcp|nc\s+-e|ncat.*-e|bash\s+-i/i.test(content)) {
      indicators.push('Reverse shell pattern');
      riskScore += 60;
    }

    // Privilege escalation
    if (/sudo\s+|chmod\s+\+s|setuid/i.test(content)) {
      indicators.push('Privilege escalation attempt');
      riskScore += 30;
    }

    // Credential access
    if (/\/etc\/shadow|\/etc\/passwd|ssh.*private.*key/i.test(content)) {
      patterns.credentialAccess = true;
      indicators.push('Accesses sensitive credential files');
      riskScore += 40;
    }

    return { indicators, dangerousFunctions, riskScore, patterns };
  }

  /**
   * Generate recommendations
   */
  private static generateRecommendations(
    riskScore: number,
    scriptType: string,
    patterns: any
  ): string[] {
    const recommendations: string[] = [];

    if (riskScore >= 60) {
      recommendations.push('CRITICAL: Do NOT execute this script');
      recommendations.push('Script contains highly suspicious code patterns');
      recommendations.push('Likely malware or exploit code');
    } else if (riskScore >= 40) {
      recommendations.push('HIGH RISK: Exercise extreme caution');
      recommendations.push('Review code carefully before execution');
      recommendations.push('Run in isolated sandbox environment only');
    } else if (riskScore >= 20) {
      recommendations.push('Script has some suspicious features');
      recommendations.push('Verify source and purpose before running');
    } else {
      recommendations.push('Script appears relatively safe');
      recommendations.push('Always review scripts from unknown sources');
    }

    if (patterns.obfuscation) {
      recommendations.push('WARNING: Code obfuscation detected');
    }

    if (patterns.encodedCommands) {
      recommendations.push('Encoded commands may hide malicious payload');
    }

    if (patterns.credentialAccess) {
      recommendations.push('ALERT: Script attempts to access credentials');
    }

    return recommendations;
  }
}
